name: compliance

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  reports-present:
    name: reports-present
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure reports dir exists
        run: |
          set -euo pipefail
          mkdir -p docs/reports

  report-gate:
    name: report-gate
    runs-on: ubuntu-latest
    needs: [reports-present]
    env:
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Require new audit report in PR
        run: |
          set -euo pipefail
          NEW_REPORTS="$(git diff --name-only --diff-filter=A "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**' || true)"
          test -n "${NEW_REPORTS}" || (echo "Missing audit report" && exit 1)

  report-content:
    name: report-content
    runs-on: ubuntu-latest
    needs: [report-gate]
    env:
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate reports additive only
        run: |
          set -euo pipefail
          NEW="$(git diff --name-only --diff-filter=A "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**')"
          MOD="$(git diff --name-only --diff-filter=MR "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**')"
          DEL="$(git diff --name-only --diff-filter=D "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**')"
          test -n "${NEW}"
          test -z "${MOD}"
          test -z "${DEL}"

  make-verify:
    name: make-verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install python package
        working-directory: python
        run: |
          set -euo pipefail
          python -m venv .venv
          . .venv/bin/activate
          pip install -U pip
          pip install -e .
      - name: Gate
        run: make gate

  evidence-pack:
    name: evidence-pack
    runs-on: ubuntu-latest
    needs: [report-content, make-verify]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build evidence
        run: |
          set -euo pipefail
          mkdir -p .aigov_ci_artifacts
          echo ok > .aigov_ci_artifacts/.keep

  upload-evidence-packs:
    name: upload-evidence-packs
    runs-on: ubuntu-latest
    needs: [evidence-pack]
    steps:
      - uses: actions/upload-artifact@v4
        with:
          name: evidence-packs
          path: .aigov_ci_artifacts
