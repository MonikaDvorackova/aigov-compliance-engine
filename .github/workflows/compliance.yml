name: compliance

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: compliance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  make-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Makefile exists
        run: |
          test -f Makefile
          echo ok

      - name: Verify Makefile targets parse
        run: |
          make -n promote RUN_ID=dummy >/dev/null

  reports-present:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports directory exists
        run: |
          test -d docs/reports
          ls -la docs/reports | head -n 50

  report-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Require new audit report when code or policy changes
        shell: bash
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" != "pull_request" ]; then
            echo "Not pull_request, skipping"
            exit 0
          fi

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}")"
          echo "Changed files:"
          echo "$CHANGED"

          NEED_REPORT=0
          echo "$CHANGED" | grep -Eq '^(python/|rust/|Makefile$|docs/policy/|policies/)' && NEED_REPORT=1 || true

          if [ "$NEED_REPORT" -eq 0 ]; then
            echo "No policy relevant changes detected"
            exit 0
          fi

          NEW_REPORTS="$(git diff --name-only --diff-filter=A "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**' || true)"
          echo "New reports:"
          echo "$NEW_REPORTS"

          if [ -z "$NEW_REPORTS" ]; then
            echo "Audit report required: add a new file under docs/reports"
            exit 2
          fi

          echo "Report gate passed"

  report-content:
    runs-on: ubuntu-latest
    needs: [report-gate]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate new reports contain required evidence fields
        shell: bash
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" != "pull_request" ]; then
            echo "Not pull_request, skipping"
            exit 0
          fi

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          NEW_REPORTS="$(git diff --name-only --diff-filter=A "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**' || true)"
          if [ -z "$NEW_REPORTS" ]; then
            echo "No new reports added"
            exit 0
          fi

          UUID_RE='[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}'
          SHA_RE='[0-9a-f]{64}'

          FAIL=0
          for f in $NEW_REPORTS; do
            echo "Checking $f"

            if ! grep -Eq "^run_id=${UUID_RE}$" "$f"; then
              echo "Missing or invalid run_id line in $f"
              FAIL=1
            fi

            if ! grep -Eq "^bundle_sha256=${SHA_RE}$" "$f"; then
              echo "Missing or invalid bundle_sha256 line in $f"
              FAIL=1
            fi

            if ! grep -Eq "^policy_version=.+$" "$f"; then
              echo "Missing or invalid policy_version line in $f"
              FAIL=1
            fi
          done

          if [ "$FAIL" -ne 0 ]; then
            echo "Report content validation failed"
            exit 2
          fi

          echo "Report content validation passed"

  evidence-pack:
    runs-on: ubuntu-latest
    needs: [report-content]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure evidence pack can be generated from new report RUN_ID
        shell: bash
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" != "pull_request" ]; then
            echo "Not pull_request, skipping"
            exit 0
          fi

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          NEW_REPORTS="$(git diff --name-only --diff-filter=A "${BASE_SHA}" "${HEAD_SHA}" -- 'docs/reports/**' || true)"
          if [ -z "$NEW_REPORTS" ]; then
            echo "No new reports added, skipping evidence pack"
            exit 0
          fi

          REPORT="$(echo "$NEW_REPORTS" | head -n 1)"
          echo "Using report $REPORT"

          RUN_ID="$(grep -E '^run_id=' "$REPORT" | head -n 1 | cut -d= -f2)"
          if [ -z "$RUN_ID" ]; then
            echo "Could not parse run_id from $REPORT"
            exit 2
          fi

          echo "RUN_ID=$RUN_ID"
          make evidence-pack RUN_ID="$RUN_ID"

          test -f "docs/packs/$RUN_ID.zip"
          echo "Evidence pack OK: docs/packs/$RUN_ID.zip"
